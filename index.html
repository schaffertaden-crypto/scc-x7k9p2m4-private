<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0f1a;
            --sidebar-bg: rgba(15, 15, 26, 0.7);
            --card-bg: rgba(255, 255, 255, 0.03);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent-color: #f43f5e;
            --highlight: #3b82f6;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --priority-low: #10b981;
            --priority-medium: #3b82f6;
            --priority-high: #f59e0b;
            --priority-critical: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        body {
            background-color: var(--bg-color);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(244, 63, 94, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 20%);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.3s ease;
        }

        .glass:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .app-container {
            display: flex;
            height: 100%;
        }

        .sidebar {
            width: 260px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            z-index: 10;
            border-right: 1px solid var(--glass-border);
            background: var(--sidebar-bg);
        }

        .logo h2 {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
            background: linear-gradient(45deg, #fff, var(--text-muted));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        nav li {
            padding: 0.8rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            border: 1px solid transparent;
        }

        nav li:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        nav li.active {
            background: rgba(244, 63, 94, 0.1);
            color: var(--accent-color);
            border-color: rgba(244, 63, 94, 0.2);
            font-weight: 600;
        }

        main {
            flex: 1;
            padding: 2.5rem;
            overflow-y: auto;
            position: relative;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            margin-bottom: 2.5rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 0.5rem;
        }

        #dashboard-greeting {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 0.2rem;
            font-weight: 500;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--highlight));
            opacity: 0.5;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .form-row {
            display: flex;
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            margin-left: 4px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.8rem 1.2rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }

        option {
            background: #1e1e2e;
            color: white;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        textarea {
            border-radius: 20px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.1);
            background: rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
            text-align: center;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 63, 94, 0.4);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid var(--glass-border);
            padding: 0.8rem 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.4rem;
            transition: all 0.2s;
            border-radius: 50%;
            color: var(--text-muted);
        }

        .ytp-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            transition: all 0.2s ease;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .ytp-button svg {
            transition: all 0.2s ease;
        }

        .ytp-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .ytp-button:active {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(0.95);
        }

        .btn-icon:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-sm:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-sm.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #fca5a5;
        }

        .tasks-container {
            display: grid;
            gap: 1rem;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .task-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.06);
        }

        .task-item h4 {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .task-item.glow-critical {
            border-left-color: var(--priority-critical);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .priority-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .p-Low {
            background: rgba(16, 185, 129, 0.15);
            color: var(--priority-low);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .p-Medium {
            background: rgba(59, 130, 246, 0.15);
            color: var(--priority-medium);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .p-High {
            background: rgba(245, 158, 11, 0.15);
            color: var(--priority-high);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .p-Critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--priority-critical);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .calendar-day {
            background: rgba(15, 15, 26, 0.8);
            min-height: 120px;
            padding: 0.8rem;
            transition: background 0.2s;
            cursor: pointer;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Current Day Circle Style - RED as requested */
        .calendar-day.current-day .day-number {
            background: #ef4444;
            /* Red Circle */
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: -4px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
        }

        .day-number {
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cal-task {
            font-size: 0.7rem;
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border-left: 2px solid var(--highlight);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cal-task:hover {
            filter: brightness(1.2);
            transform: scale(1.02);
        }

        .timer-container {
            margin: 2rem auto;
            padding: 4rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 600px;
            position: relative;
        }

        .timer-container::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(45deg, transparent, var(--accent-color), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .timer-display {
            font-size: 7rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 2rem;
            background: linear-gradient(180deg, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.1));
        }

        .timer-controls {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .timer-settings {
            width: 100%;
            border-top: 1px solid var(--glass-border);
            padding-top: 2rem;
            text-align: left;
        }

        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }

        .grade-card {
            padding: 2rem;
        }

        .grade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .grade-score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--highlight);
            font-family: 'JetBrains Mono', monospace;
        }

        .category-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            align-items: center;
        }

        .category-row input {
            padding: 0.6rem 0.5rem;
            font-size: 0.85rem;
            border-radius: 8px;
            min-width: 0;
            text-align: center;
        }

        .cat-name {
            flex: 2;
            text-align: left !important;
        }

        .cat-weight {
            flex: 1;
        }

        .cat-score {
            flex: 1;
        }

        .music-player {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .album-art {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent-color), var(--highlight));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .track-details h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .track-details p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
        }

        .player-scrubber,
        .player-volume {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .player-scrubber input[type="range"],
        .player-volume input[type="range"] {
            flex: 1;
            height: 4px;
            padding: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 2px;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.5);
            background: var(--accent-color);
        }

        .ai-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.8rem;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 10px rgba(168, 85, 247, 0.3);
            color: white;
        }

        .ai-btn:hover {
            transform: scale(1.15) rotate(15deg);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.6);
        }

        .ai-content {
            white-space: pre-wrap;
            line-height: 1.7;
            color: #e2e8f0;
            font-size: 1.05rem;
        }

        /* MathJax styling */
        .ai-content mjx-container {
            display: inline-block !important;
            margin: 5px 0;
        }

        .ai-loading {
            text-align: center;
            font-style: italic;
            color: var(--text-muted);
            padding: 2rem;
        }

        .user-msg {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px 12px 0 12px;
            margin-bottom: 1rem;
            align-self: flex-end;
            max-width: 80%;
        }

        .ai-msg {
            background: rgba(168, 85, 247, 0.15);
            padding: 1rem;
            border-radius: 12px 12px 12px 0;
            margin-bottom: 1rem;
            align-self: flex-start;
            max-width: 80%;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        /* Calendar Filter Pills */
        .calendar-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .cal-filter-pill {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .cal-filter-pill.active {
            background: var(--highlight);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .cal-filter-pill:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #datetime-display {
            font-family: 'JetBrains Mono', monospace;
        }

        .datetime-time {
            font-size: 1.5rem;
            font-weight: 700;
            margin-right: 1rem;
            color: white;
        }

        /* Chat History Styles */
        .history-item {
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-question {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.3rem;
        }

        .history-timestamp {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Floating Action Button (FAB) Menu */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 200;
            /* High Z-Index to stay on top */
            display: flex;
            flex-direction: column-reverse;
            /* Stack upwards */
            align-items: center;
            gap: 12px;
        }

        .fab-main {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(244, 63, 94, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 2;
        }

        .fab-main:hover {
            transform: scale(1.1);
        }

        .fab-main.active {
            transform: rotate(45deg);
            background: #ef4444;
        }

        .fab-menu-item {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        .fab-menu-item:hover {
            background: var(--highlight);
            color: white;
            transform: scale(1.1) !important;
        }

        /* Tooltip for FAB items */
        .fab-menu-item::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 60px;
            left: auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            color: white;
        }

        .fab-menu-item:hover::after {
            opacity: 1;
        }

        .fab-container.open .fab-menu-item {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        /* Stagger animation delays */
        .fab-container.open .fab-menu-item:nth-child(2) {
            transition-delay: 0.05s;
        }

        .fab-container.open .fab-menu-item:nth-child(3) {
            transition-delay: 0.1s;
        }

        .fab-container.open .fab-menu-item:nth-child(4) {
            transition-delay: 0.15s;
        }

        .fab-container.open .fab-menu-item:nth-child(5) {
            transition-delay: 0.2s;
        }

        .version-tag {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.15);
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 90;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 2px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 300;
            /* Ensure modal is above everything including FAB */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-width: 600px;
            padding: 2.5rem;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            background: #1e1e2e;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-actions {
            display: flex;
            flex-direction: column-reverse;
            gap: 1rem;
            margin-top: 2rem;
        }

        .drop-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.01);
        }

        .drop-zone:hover {
            border-color: var(--accent-color);
            background: rgba(244, 63, 94, 0.05);
            transform: scale(1.02);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar glass">
            <div class="logo">
                <h2>Command Center</h2>
            </div>
            <nav>
                <ul>
                    <li data-tab="dashboard" class="active">üìä Dashboard</li>
                    <li data-tab="pending">üìù Assignments</li>
                    <li data-tab="grades">üéì Grades</li>
                    <li data-tab="calendar">üìÖ Calendar</li>
                    <li data-tab="timer">‚è±Ô∏è Study Timer</li>
                    <li data-tab="completed">‚úÖ History</li>
                </ul>
            </nav>
            <div class="music-player glass" style="padding: 1rem; margin-top: auto;">
                <div class="player-info">
                    <div class="album-art">üéµ</div>
                    <div class="track-details">
                        <h4 id="track-title">Track Title</h4>
                        <p id="track-artist">Artist</p>
                    </div>
                </div>
                <div class="player-controls">
                    <button class="ytp-button" id="rewind-btn" title="Rewind 10s">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M11 16.07V7.93C11 7.46 10.44 7.22 10.1 7.56L6.03 11.63C5.83 11.83 5.83 12.17 6.03 12.37L10.1 16.44C10.44 16.78 11 16.54 11 16.07ZM18 16.07V7.93C18 7.46 17.44 7.22 17.1 7.56L13.03 11.63C12.83 11.83 12.83 12.17 13.03 12.37L17.1 16.44C17.44 16.78 18 16.54 18 16.07Z"
                                fill="white" />
                        </svg>
                    </button>

                    <button class="ytp-button" id="play-pause" title="Play">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="play-icon">
                            <path d="M8 5v14l11-7z" fill="white" />
                        </svg>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="pause-icon"
                            style="display:none;">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" fill="white" />
                        </svg>
                    </button>

                    <button class="ytp-button" id="forward-btn" title="Forward 10s">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M5.5 7.93V16.07C5.5 16.54 6.06 16.78 6.4 16.44L10.47 12.37C10.67 12.17 10.67 11.83 10.47 11.63L6.4 7.56C6.06 7.22 5.5 7.46 5.5 7.93ZM12.5 7.93V16.07C12.5 16.54 13.06 16.78 13.4 16.44L17.47 12.37C17.67 12.17 17.67 11.83 17.47 11.63L13.4 7.56C13.06 7.22 12.5 7.46 12.5 7.93Z"
                                fill="white" />
                        </svg>
                    </button>
                </div>
                <div class="player-scrubber"><span id="current-time">0:00</span><input type="range" id="seek-slider"
                        value="0" max="100"><span id="duration">0:00</span></div>
                <div class="player-volume">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                        style="flex-shrink:0;">
                        <path
                            d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
                            fill="var(--text-muted)" />
                    </svg>
                    <input type="range" id="volume-slider" value="100" max="100">
                </div>
            </div>
        </aside>
        <main>
            <div id="datetime-display"
                style="position: absolute; top: 2rem; right: 2rem; text-align: right; font-size: 1.2rem; color: var(--text-muted);">
            </div>
            <section id="dashboard" class="view active">
                <header>
                    <div id="dashboard-greeting"></div>
                    <h1>Dashboard</h1>
                </header>
                <div class="dashboard-grid">
                    <div class="stat-card glass" id="due-today-card" onclick="filterView('today')"
                        title="Click to see tasks due today">
                        <h3>Due Today</h3>
                        <div class="stat-number" id="due-today-count">0</div>
                    </div>
                    <div class="stat-card glass" id="due-week-card" onclick="filterView('week')"
                        title="Click to see tasks due this week">
                        <h3>Due This Week</h3>
                        <div class="stat-number" id="due-week-count">0</div>
                    </div>
                    <div class="stat-card glass" id="weekly-progress-card" onclick="goToHistory('week')"
                        title="View completed tasks this week">
                        <h3>Weekly Progress</h3>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Completion</span><span id="progress-text">0%</span>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="weekly-progress"
                                    style="height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); width: 0%; transition: width 0.5s ease;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div class="glass" style="padding: 1.5rem; cursor: pointer;" onclick="filterView('urgent')"
                        title="See urgent tasks">
                        <h3>üî• Urgent Tasks</h3>
                        <ul id="urgent-tasks-list" style="list-style: none; margin-top: 1rem;"></ul>
                    </div>
                    <div class="glass" style="padding: 1.5rem; cursor: pointer;" onclick="filterView('next10')"
                        title="See upcoming tasks">
                        <h3>üìÖ Next Events</h3>
                        <ul id="next-events-list" style="list-style: none; margin-top: 1rem;"></ul>
                    </div>
                </div>
                <div class="glass"
                    style="padding: 1.5rem; margin-top: 2rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer;"
                    onclick="switchTab('timer')" title="Go to Study Timer">
                    <div>
                        <h3>‚è±Ô∏è Mini Timer</h3>
                        <div id="mini-timer-display"
                            style="font-size: 2rem; font-weight: bold; font-family: monospace;">25:00</div>
                    </div>
                    <div>
                        <button id="mini-timer-toggle" class="btn-primary"
                            style="width: auto; display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.8rem 1.2rem;"
                            onclick="event.stopPropagation()">
                            <svg class="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5v14l11-7z" fill="currentColor" />
                            </svg>
                            <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" style="display:none;">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" fill="currentColor" />
                            </svg>
                        </button>
                        <button id="mini-timer-reset" class="btn-sm"
                            style="margin-left: 0.5rem; display: inline-flex; align-items: center; padding: 0.8rem;"
                            onclick="event.stopPropagation(); resetTimer(true);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                                    fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
            <section id="pending" class="view">
                <header>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <h1>Assignments</h1>
                        <div id="filter-status-container" style="display:none; align-items: center; gap: 10px;">
                            <span id="filter-status-text" style="color: var(--text-muted); font-size: 0.9rem;"></span>
                            <button class="btn-sm"
                                style="background: var(--accent-color); padding: 0.3rem 0.8rem; font-size: 0.8rem;"
                                onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </header>

                <div style="margin-bottom: 1rem; display: flex; gap: 1rem;"><button id="sort-date" class="btn-sm">Sort
                        by Date</button><button id="sort-priority" class="btn-sm">Sort by Priority</button>
                </div>
                <div id="pending-tasks-container" class="tasks-container"></div>
            </section>
            <section id="grades" class="view">
                <header>
                    <h1>Grade Calculator</h1><button id="save-grades" class="btn-primary"
                        style="width: auto; margin-top: 10px;">Save All
                        Grades</button>
                </header>
                <div id="grades-grid" class="grades-grid"></div>
            </section>
            <section id="calendar" class="view">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <h2 id="calendar-month-year" style="color: var(--text-main); font-size: 1.5rem;"></h2>
                </div>
                <header style="margin-bottom: 1rem;">
                    <h1>Calendar</h1>
                </header>
                <div id="calendar-filters" class="calendar-filters"></div>
                <div id="calendar-grid" class="calendar-grid"></div>
                <p style="text-align:center; color:var(--text-muted); font-size:0.8rem; margin-top:0.5rem;">Double-click
                    a day to add an event.</p>
            </section>
            <section id="timer" class="view">
                <header>
                    <h1>Study Timer</h1>
                </header>
                <div class="timer-container glass">
                    <div class="timer-header">
                        <div id="timer-phase" class="timer-phase">Work Session</div>
                        <div id="session-count" class="session-count">Sessions: 0/4</div>
                    </div>
                    <div id="timer-display" class="timer-display">25:00</div>
                    <div class="timer-controls"><button id="timer-start" class="btn-primary">Start</button><button
                            id="timer-pause" class="btn-primary"
                            style="display: none; background: var(--priority-high);">Pause</button><button
                            id="timer-reset" class="btn-sm">Reset</button></div>
                    <div class="timer-settings">
                        <h3>Settings (Minutes)</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Work</label><input type="number" id="work-duration"
                                    value="25"></div>
                            <div class="form-group"><label>Short Break</label><input type="number"
                                    id="short-break-duration" value="5"></div>
                            <div class="form-group"><label>Long Break</label><input type="number"
                                    id="long-break-duration" value="15"></div>
                        </div>
                        <button id="save-timer-settings" class="btn-sm">Save Settings</button>
                    </div>
                </div>
            </section>
            <section id="completed" class="view">
                <header style="flex-direction: column; align-items: flex-start; gap: 1rem;">
                    <h1>History</h1>
                    <button id="clear-completed" class="btn-sm danger">Clear All</button>
                </header>
                <div id="history-filter-msg" style="display:none; color:var(--accent-color); margin-bottom:1rem;">
                    Showing tasks completed this week</div>
                <div id="completed-tasks-container" class="tasks-container"></div>
            </section>
        </main>
    </div>

    <div class="fab-container" id="fab-menu">
        <button class="fab-main" id="fab-trigger">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
        <button class="fab-menu-item" id="fab-add-event" title="Add Event" data-tooltip="Add Event">‚ûï</button>
        <button class="fab-menu-item" id="fab-upload-cal" title="Upload Calendar"
            data-tooltip="Upload .ics File">üìÖ</button>
        <button class="fab-menu-item" id="fab-link-cal" title="Link Calendar"
            data-tooltip="Link Calendar URL">üîó</button>
        <button class="fab-menu-item" id="fab-settings" title="Settings" data-tooltip="Settings">‚öôÔ∏è</button>
        <button class="fab-menu-item" id="fab-tutor" title="Gemini Tutor" data-tooltip="Gemini Tutor">‚ú®</button>
    </div>

    <div class="version-tag">v2.4</div>

    <div id="add-task-modal" class="modal">
        <div class="modal-content glass">
            <h2 id="modal-task-header">Add New Event</h2>
            <form id="modal-task-form" style="margin-top: 1.5rem;">
                <input type="hidden" id="modal-task-id">
                <div class="form-row">
                    <div class="form-group"><label for="modal-class-select">Class</label><select id="modal-class-select"
                            required class="glass-input" style="width:100%;"></select></div>
                    <div class="form-group"><label for="modal-category-select">Category</label><select
                            id="modal-category-select" class="glass-input" style="width:100%;">
                            <option value="">None</option>
                        </select></div>
                </div>
                <div class="form-group"><label for="modal-task-title">Title</label><input type="text"
                        id="modal-task-title" required placeholder="e.g. Chapter 5 Exercises">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-due-date">Date/Time</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <input type="checkbox" id="modal-all-day-toggle" onchange="window.toggleModalAllDay()">
                            <label for="modal-all-day-toggle" style="margin:0; cursor:pointer; font-size: 0.8rem;">All
                                Day</label>
                        </div>
                        <input type="datetime-local" id="modal-due-date" required>
                    </div>
                    <div class="form-group"><label for="modal-priority">Priority</label><select id="modal-priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select></div>
                </div>
                <div class="form-group"><label for="modal-notes">Notes</label><textarea id="modal-notes" rows="3"
                        placeholder="Additional details..."></textarea></div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" id="modal-submit-btn" class="btn-primary">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content glass">
            <h2>Import Assignments</h2>
            <div id="drop-zone" class="drop-zone" style="margin-bottom: 1rem;">
                <p>Drag & Drop .ics file here</p><small>or click to upload</small><input type="file" id="ics-input"
                    accept=".ics" style="display:none;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="import-target-class" style="display: block; margin-bottom: 0.5rem;">Assign to Class:</label>
                <select id="import-target-class" class="glass-input" style="width:100%;"></select>
            </div>
            <p>Select the events you want to import:</p>
            <div
                style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <input type="checkbox" id="select-all-import" checked>
                <label for="select-all-import" style="cursor: pointer; font-weight: bold;">Select All / Deselect
                    All</label>
            </div>
            <div id="import-list" class="import-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
            </div>
            <div class="modal-actions">
                <button id="cancel-import" class="btn-secondary">Close</button>
                <button id="confirm-import" class="btn-primary">Import Selected</button>
            </div>
        </div>
    </div>

    <div id="ai-history-modal" class="modal" style="z-index: 310;">
        <div class="modal-content glass" style="height: 80vh; max-width: 600px;">
            <h2>Chat History</h2>
            <div id="ai-history-list" style="flex:1; overflow-y: auto; margin-top:1rem;">
            </div>
            <div class="modal-actions">
                <button onclick="document.getElementById('ai-history-modal').classList.remove('active')"
                    class="btn-secondary">Close</button>
                <button onclick="window.clearAiHistory()" class="btn-primary" style="background: #ef4444;">Clear
                    History</button>
            </div>
        </div>
    </div>

    <div id="ai-modal" class="modal">
        <div class="modal-content glass" style="height: 80vh; max-width: 800px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="ai-modal-title">‚ú® AI Tutor</h2>
                <button id="ai-history-btn" class="btn-sm" style="background: rgba(255,255,255,0.1);">üìú
                    History</button>
            </div>

            <div id="ai-chat-container"
                style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; margin-bottom: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 1rem;">
                <div class="ai-msg">Hello! I'm your Gemini Tutor. How can I help you study today?</div>
            </div>

            <div id="ai-file-preview"
                style="display: none; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 0.5rem; align-items: center; justify-content: space-between;">
                <span id="ai-filename"
                    style="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">filename.txt</span>
                <button id="remove-file-btn"
                    style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>

            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button id="ai-attach-btn" class="btn-icon" title="Attach File"
                    style="color: var(--accent-color); padding: 0.5rem;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                        </path>
                    </svg>
                </button>
                <input type="file" id="ai-file-input" style="display: none;"
                    accept=".pdf,.txt,.md,.js,.py,.html,.css,.csv,.xml,.rtf,.png,.jpg,.jpeg,.webp">

                <input type="text" id="ai-input" placeholder="Ask a question..." style="flex: 1;">
                <button id="ai-send" class="btn-primary" style="width: auto;">Send</button>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">Supported: PDF, Images, Text
                (TXT, MD, Code)</div>
            <button onclick="document.getElementById('ai-modal').classList.remove('active')" class="btn-secondary"
                style="margin-top: 1rem; width: 100%;">Close</button>
        </div>
    </div>

    <div id="name-modal" class="modal" style="z-index: 200;">
        <div class="modal-content glass" style="max-width: 400px; text-align: center;">
            <h2>Welcome!</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-muted);">What should we call you?</p>
            <input type="text" id="user-name-input" placeholder="Your First Name"
                style="margin-bottom: 1.5rem; text-align: center;">
            <button id="save-name-btn" class="btn-primary">Get Started</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content glass">
            <h2>‚öôÔ∏è Settings</h2>

            <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">ü§ñ Google Gemini API Key</h3>
            <div class="form-group">
                <input type="password" id="settings-api-key" placeholder="Enter your API Key">
                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Key is stored locally in
                    your browser.</small>
                <a href="https://docs.google.com/document/d/1l2jWOPWzPbJuQWTGML5oOtR3OzaK19Gz2Bzkpm0F-O4/edit?usp=sharing"
                    target="_blank"
                    style="color: var(--highlight); text-decoration: none; font-size: 0.9rem; display: block; margin-top: 0.5rem;">Click
                    here to learn how to get a Free API key for Gemini Tutor</a>
            </div>

            <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">üìö Class Names</h3>
            <div id="settings-classes-list">
            </div>

            <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">üëÅÔ∏è Calendar Visibility</h3>
            <div id="settings-calendars-list">
            </div>

            <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">üíæ Data Management</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button id="export-data" class="btn-sm"
                    style="flex: 1; background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5);">
                    üì§ Export Data Backup
                </button>
                <button id="import-data-btn" class="btn-sm"
                    style="flex: 1; background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5);">
                    üì• Restore Data Backup
                </button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>
            <div>
                <button id="clear-data-btn" class="btn-sm"
                    style="margin-top: 1rem; width: 100%; background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); color: #ef4444;">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
            <p style="color: var(--text-muted); margin-top: 1rem; margin-bottom: 0.5rem;">Use these options if you are:
            </p>
            <ul style="color: var(--text-muted); margin-bottom: 1rem; padding-left: 1.5rem; line-height: 1.6;">
                <li>Trying to transfer data between devices</li>
                <li>Clearing your cache</li>
                <li>Resetting your PC</li>
                <li>Updating this Command Center webpage</li>
                <li>Noticing your data isn't being saved</li>
            </ul>
            <p style="color: var(--text-muted); font-style: italic;">We also recommend doing this each time you make a
                big change, to prevent data loss.</p>

            <div class="modal-actions" style="margin-top: 2rem;">
                <button id="close-settings" class="btn-secondary">Close</button>
                <button id="save-settings" class="btn-primary">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="url-import-modal" class="modal">
        <div class="modal-content glass">
            <h2>üîó Link Calendar</h2>
            <a href="https://docs.google.com/document/d/120uN03jhndBI_jkclTFG4TkBpdIXSM-55Hs2UBodVQ0/edit?usp=sharing"
                target="_blank"
                style="color: var(--highlight); text-decoration: none; display: block; margin-bottom: 1rem;">How to Find
                Your Private Google Calendar Link</a>
            <input type="text" id="cal-url-input" placeholder="https://example.com/calendar.ics">
            <div class="modal-actions" style="margin-top: 1.5rem;">
                <button onclick="document.getElementById('url-import-modal').classList.remove('active')"
                    class="btn-secondary">Close</button>
                <button id="confirm-url-import" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal" style="z-index: 500;">
        <div class="modal-content glass" style="max-width: 650px;">
            <h2 style="color: var(--accent-color); margin-bottom: 1rem;">üöÄ What's New in v2.3</h2>
            <div style="overflow-y: auto; max-height: 60vh; line-height: 1.6;">
                <ul style="padding-left: 1.5rem; list-style-type: disc; color: var(--text-main);">
                    <li><strong>Red Circle on Calendar:</strong> The current date is now clearly highlighted with a red
                        circle, just like Google Calendar.</li>
                    <li><strong>Easy Event Adding:</strong>
                        <ul
                            style="padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; list-style-type: circle;">
                            <li>Use the <strong>Super Action Button (+)</strong> in the corner.</li>
                            <li><strong>Double-click</strong> any date on the calendar grid.</li>
                            <li>Removed cluttered "Add Event" buttons from other views.</li>
                        </ul>
                    </li>
                    <li><strong>AI Tutor Upgrades:</strong>
                        <ul
                            style="padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; list-style-type: circle;">
                            <li><strong>History Button:</strong> View your past conversations.</li>
                            <li><strong>Math Rendering:</strong> Mathematical equations now display beautifully using
                                LaTeX.</li>
                        </ul>
                    </li>
                    <li><strong>Undo / Redo:</strong> Made a mistake? Press <strong>Ctrl+Z</strong> to undo and
                        <strong>Ctrl+Y</strong> to redo changes.
                    </li>
                    <li><strong>Better Editing:</strong> Editing an assignment no longer resets the selected Class.</li>
                    <li><strong>Volume Control:</strong> The music player volume slider is now colorful and uses a
                        logarithmic scale for smoother adjustment.</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button onclick="document.getElementById('changelog-modal').classList.remove('active')"
                    class="btn-primary">Awesome!</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let assignments = [];
        let grades = [];
        let timerState = { timeLeft: 25 * 60, isRunning: false, mode: 'work', sessionCount: 0, settings: { work: 25, shortBreak: 5, longBreak: 15 } };
        let timerInterval = null;
        let audioCtx = null;
        let currentAiTask = null;
        let currentFilter = 'all';
        let calendarVisibility = {};
        let aiAttachment = null;
        let aiChatHistory = [];
        let currentSort = 'date';

        // Undo/Redo History Stacks
        let appHistory = [];
        let redoStack = [];
        let isUndoing = false;
        const MAX_HISTORY = 50;

        // --- DOM Elements ---
        let pendingContainer, completedContainer, urgentList, nextEventsList;
        let weeklyProgress, progressText, calendarGrid, calendarFilters;
        let tabs, views, datetimeDisplay, classSelect, categorySelect;
        let filterStatusContainer, filterStatusText;
        let modalTaskForm, modalClassSelect, modalCategorySelect, addTaskModal, modalCancelBtn;

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            checkUserName();
            checkVersion(); // Check for changelog
            loadFromLocal();
            loadTimerSettings();
            loadGrades();

            // Initialize DOM Elements
            pendingContainer = document.getElementById('pending-tasks-container');
            completedContainer = document.getElementById('completed-tasks-container');
            urgentList = document.getElementById('urgent-tasks-list');
            nextEventsList = document.getElementById('next-events-list');
            weeklyProgress = document.getElementById('weekly-progress');
            progressText = document.getElementById('progress-text');
            calendarGrid = document.getElementById('calendar-grid');
            calendarFilters = document.getElementById('calendar-filters');
            tabs = document.querySelectorAll('.sidebar nav li');
            views = document.querySelectorAll('.view');
            datetimeDisplay = document.getElementById('datetime-display');

            // Modal Elements
            modalTaskForm = document.getElementById('modal-task-form');
            modalClassSelect = document.getElementById('modal-class-select');
            modalCategorySelect = document.getElementById('modal-category-select');
            addTaskModal = document.getElementById('add-task-modal');
            modalCancelBtn = document.getElementById('modal-cancel-btn');

            // Filter Elements
            filterStatusContainer = document.getElementById('filter-status-container');
            filterStatusText = document.getElementById('filter-status-text');

            // Logic Startup
            renderAll();
            setupTabs();
            setupSorting();
            setupTimer();
            setupImporter();
            setupMusicPlayer();
            setupGrades();
            setupFab();
            setupSettings();
            setupAiChat();
            setupBackupRestore();
            setupUndoRedo(); // Initialize Undo/Redo listeners
            setupHistory();
            autoSyncCalendar();
            setInterval(autoSyncCalendar, 15 * 60 * 1000); // 15 minutes * 60 seconds * 1000 ms
            startClock();

            if (modalClassSelect) modalClassSelect.addEventListener('change', updateModalCategorySelect);
            populateClassSelect();

            // Expose functions for HTML onclick attributes
            window.switchTab = switchTab;
            window.filterView = filterView;
            window.goToHistory = goToHistory;
            window.clearFilters = clearFilters;
            window.toggleComplete = toggleComplete;
            window.editAssignment = editAssignment;
            window.deleteAssignment = deleteAssignment;
            window.askAI = askAI;
            window.toggleModalAllDay = toggleModalAllDay;
            window.clearAiHistory = clearAiHistory;
            window.resetTimer = resetTimer;
            window.addCategory = addCategory;
            window.removeCategory = removeCategory;
            window.openAddModal = openAddModal;

            window.addEventListener('beforeunload', () => {
                saveToLocal();
                saveGrades();
                saveTimerSettings();
            });

            if (modalCancelBtn) modalCancelBtn.addEventListener('click', () => addTaskModal.classList.remove('active'));
            if (modalTaskForm) modalTaskForm.addEventListener('submit', addAssignment);
        });

        // --- 3. FUNCTIONS ---

        function checkVersion() {
            const CURRENT_VERSION = "2.3";
            const storedVersion = localStorage.getItem('app_version');
            if (storedVersion !== CURRENT_VERSION) {
                document.getElementById('changelog-modal').classList.add('active');
                localStorage.setItem('app_version', CURRENT_VERSION);
            }
            // Add Ctrl+Enter shortcut for changelog
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    const changelogModal = document.getElementById('changelog-modal');
                    if (changelogModal && changelogModal.classList.contains('active')) {
                        e.preventDefault();
                        changelogModal.classList.remove('active');
                    }
                }
            });
        }

        function checkUserName() {
            const name = localStorage.getItem('userName');
            if (name) {
                updateGreeting(name);
            } else {
                const modal = document.getElementById('name-modal');
                if (modal) modal.classList.add('active');
            }
            setInterval(() => {
                const n = localStorage.getItem('userName');
                if (n) updateGreeting(n);
            }, 3600000);
        }

        const saveNameBtn = document.getElementById('save-name-btn');
        if (saveNameBtn) {
            saveNameBtn.addEventListener('click', () => {
                const input = document.getElementById('user-name-input');
                const name = input.value.trim() || 'Student';
                localStorage.setItem('userName', name);
                updateGreeting(name);
                document.getElementById('name-modal').classList.remove('active');
            });
        }

        // Add Ctrl+Enter shortcut for name input
        const nameInput = document.getElementById('user-name-input');
        if (nameInput) {
            nameInput.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    if (saveNameBtn) saveNameBtn.click();
                }
            });
        }

        function updateGreeting(name) {
            if (!name) name = localStorage.getItem('userName') || 'Student';
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17 && hour < 22) greeting = 'Good evening';
            else if (hour >= 22 || hour < 5) greeting = 'Good night';

            const el = document.getElementById('dashboard-greeting');
            if (el) el.innerText = `${greeting}, ${name}`;
        }

        function startClock() {
            function update() {
                const now = new Date();
                const dateStr = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const timeStr = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                if (datetimeDisplay) datetimeDisplay.innerHTML = `<span class="datetime-time">${timeStr}</span><span>${dateStr}</span>`;
            }
            update(); setInterval(update, 1000);
        }

        function saveToLocal() {
            localStorage.setItem('assignments', JSON.stringify(assignments));
            localStorage.setItem('calendarVisibility', JSON.stringify(calendarVisibility));
            localStorage.setItem('aiChatHistory', JSON.stringify(aiChatHistory));
            renderAll();
        }
        function saveTimerSettings() { localStorage.setItem('timerSettings', JSON.stringify(timerState.settings)); localStorage.setItem('sessionCount', timerState.sessionCount); }
        function loadFromLocal() {
            const stored = localStorage.getItem('assignments');
            if (stored) {
                assignments = JSON.parse(stored);
                // Migrate old assignments - ensure they have all required properties
                assignments = assignments.map(task => ({
                    id: task.id || Date.now().toString(),
                    className: task.className || 'Class 1',
                    category: task.category || '',
                    title: task.title || 'Untitled',
                    dueDate: task.dueDate || new Date().toISOString(),
                    priority: task.priority || 'Medium',
                    completed: task.completed !== undefined ? task.completed : false,
                    notes: task.notes || ''
                }));
            }
            const storedVis = localStorage.getItem('calendarVisibility');
            if (storedVis) calendarVisibility = JSON.parse(storedVis);
            const storedHistory = localStorage.getItem('aiChatHistory');
            if (storedHistory) aiChatHistory = JSON.parse(storedHistory);
        }
        function loadTimerSettings() { const storedSettings = localStorage.getItem('timerSettings'); if (storedSettings) timerState.settings = JSON.parse(storedSettings); const storedSessions = localStorage.getItem('sessionCount'); if (storedSessions) timerState.sessionCount = parseInt(storedSessions); }

        function loadGrades() {
            const stored = localStorage.getItem('grades');
            if (stored) {
                grades = JSON.parse(stored);
                grades.forEach(course => {
                    const hasQuiz = course.categories.some(c => c.name === 'Quizzes');
                    const hasProject = course.categories.some(c => c.name === 'Projects');
                    if (!hasQuiz) course.categories.push({ name: 'Quizzes', weight: 0, score: 100 });
                    if (!hasProject) course.categories.push({ name: 'Projects', weight: 0, score: 100 });
                });
            } else {
                for (let i = 0; i < 5; i++) {
                    grades.push({
                        name: `Class ${i + 1}`,
                        categories: [
                            { name: 'Homework', weight: 20, score: 100 },
                            { name: 'Tests', weight: 30, score: 100 },
                            { name: 'Quizzes', weight: 10, score: 100 },
                            { name: 'Projects', weight: 20, score: 100 },
                            { name: 'Final', weight: 20, score: 100 }
                        ]
                    });
                }
            }
        }

        // --- UNDO / REDO LOGIC ---

        function setupUndoRedo() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key.toLowerCase() === 'z') {
                    e.preventDefault();
                    undoAction();
                }
                if (e.ctrlKey && e.key.toLowerCase() === 'y') {
                    e.preventDefault();
                    redoAction();
                }
            });
        }

        function saveState() {
            if (isUndoing) return;
            const state = {
                assignments: JSON.parse(JSON.stringify(assignments)),
                grades: JSON.parse(JSON.stringify(grades))
            };
            appHistory.push(state);
            if (appHistory.length > MAX_HISTORY) appHistory.shift();
            redoStack = []; // Clear redo stack on new action
        }

        function undoAction() {
            if (appHistory.length === 0) return;
            isUndoing = true;

            // Save current state to redo stack first
            const currentState = {
                assignments: JSON.parse(JSON.stringify(assignments)),
                grades: JSON.parse(JSON.stringify(grades))
            };
            redoStack.push(currentState);

            const prevState = appHistory.pop();
            assignments = prevState.assignments;
            grades = prevState.grades;

            saveToLocal();
            saveGrades();
            renderAll();
            renderGrades();

            isUndoing = false;

            // Show feedback
            const toast = document.createElement('div');
            toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--accent-color); color:white; padding:10px 20px; border-radius:50px; z-index:1000; animation: fadeIn 0.3s;";
            toast.innerText = "Undo Successful";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function redoAction() {
            if (redoStack.length === 0) return;
            isUndoing = true;

            // Save current state to history stack
            const currentState = {
                assignments: JSON.parse(JSON.stringify(assignments)),
                grades: JSON.parse(JSON.stringify(grades))
            };
            appHistory.push(currentState);

            const nextState = redoStack.pop();
            assignments = nextState.assignments;
            grades = nextState.grades;

            saveToLocal();
            saveGrades();
            renderAll();
            renderGrades();

            isUndoing = false;

            // Show feedback
            const toast = document.createElement('div');
            toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--priority-medium); color:white; padding:10px 20px; border-radius:50px; z-index:1000; animation: fadeIn 0.3s;";
            toast.innerText = "Redo Successful";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function setupBackupRestore() {
            document.getElementById('export-data').addEventListener('click', () => {
                const data = {
                    assignments,
                    grades,
                    timerSettings: timerState.settings,
                    sessionCount: timerState.sessionCount,
                    apiKey: localStorage.getItem('gemini_api_key'),
                    calendarVisibility,
                    userName: localStorage.getItem('userName'),
                    aiChatHistory,
                    exportedAt: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `study-command-center-backup-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            const fileInput = document.getElementById('import-file-input');
            document.getElementById('import-data-btn').addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.assignments) assignments = data.assignments;
                        if (data.grades) grades = data.grades;
                        if (data.timerSettings) timerState.settings = data.timerSettings;
                        if (data.sessionCount) timerState.sessionCount = data.sessionCount;
                        if (data.apiKey) localStorage.setItem('gemini_api_key', data.apiKey);
                        if (data.calendarVisibility) calendarVisibility = data.calendarVisibility;
                        if (data.userName) localStorage.setItem('userName', data.userName);
                        if (data.aiChatHistory) aiChatHistory = data.aiChatHistory;

                        saveToLocal();
                        saveGrades();
                        saveTimerSettings();
                        renderGrades();
                        populateClassSelect();
                        checkUserName();
                        alert('Data restored successfully! The page will now refresh.');
                        location.reload();
                    } catch (err) {
                        alert('Error importing data. Invalid file format.');
                    }
                };
                reader.readAsText(file);
            });
        }

        function setupFab() {
            const trigger = document.getElementById('fab-trigger');
            const container = document.getElementById('fab-menu');

            trigger.addEventListener('click', () => {
                container.classList.toggle('open');
                trigger.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    container.classList.remove('open');
                    trigger.classList.remove('active');
                }
            });

            document.getElementById('fab-add-event').addEventListener('click', () => {
                openAddModal();
            });

            document.getElementById('fab-upload-cal').addEventListener('click', () => {
                document.getElementById('import-modal').classList.add('active');
                populateImportClassSelect();
            });

            document.getElementById('fab-link-cal').addEventListener('click', () => {
                document.getElementById('url-import-modal').classList.add('active');
            });

            document.getElementById('fab-settings').addEventListener('click', openSettings);

            document.getElementById('fab-tutor').addEventListener('click', () => {
                currentAiTask = null;
                document.getElementById('ai-modal-title').innerText = "‚ú® Gemini Tutor (General Help)";
                document.getElementById('ai-chat-container').innerHTML = '<div class="ai-msg">Hello! I\'m your Gemini Tutor. How can I help you study today?</div>';
                document.getElementById('ai-modal').classList.add('active');
            });

            document.getElementById('confirm-url-import').addEventListener('click', importFromUrl);
        }

        function openSettings() {
            const modal = document.getElementById('settings-modal');
            const keyInput = document.getElementById('settings-api-key');
            keyInput.value = localStorage.getItem('gemini_api_key') || '';
            renderSettingsClassesList();
            renderSettingsCalendarList();
            modal.classList.add('active');
        }

        function renderSettingsClassesList() {
            const container = document.getElementById('settings-classes-list');
            container.innerHTML = '';
            grades.forEach((g, i) => {
                const row = document.createElement('div');
                row.style.marginBottom = '0.5rem';
                row.innerHTML = `<input type="text" value="${g.name}" data-index="${i}" class="class-name-edit">`;
                container.appendChild(row);
            });
            const addBtn = document.createElement('button');
            addBtn.className = 'btn-sm';
            addBtn.innerText = '+ Add Class';
            addBtn.style.marginTop = '0.5rem';
            addBtn.onclick = () => {
                saveState(); // Save before adding
                grades.push({
                    name: `Class ${grades.length + 1}`,
                    categories: [
                        { name: 'Homework', weight: 20, score: 100 },
                        { name: 'Tests', weight: 30, score: 100 },
                        { name: 'Quizzes', weight: 10, score: 100 },
                        { name: 'Projects', weight: 20, score: 100 },
                        { name: 'Final', weight: 20, score: 100 }
                    ]
                });
                renderSettingsClassesList();
            };
            container.appendChild(addBtn);
        }

        function renderSettingsCalendarList() {
            const container = document.getElementById('settings-calendars-list');
            container.innerHTML = '';
            const sources = new Set(grades.map(g => g.name));
            assignments.forEach(a => sources.add(a.className));

            sources.forEach(source => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.marginBottom = '0.5rem';
                row.style.padding = '0.5rem';
                row.style.background = 'rgba(255,255,255,0.05)';
                row.style.borderRadius = '8px';

                const label = document.createElement('span');
                label.innerText = source;

                const toggle = document.createElement('input');
                toggle.type = 'checkbox';
                toggle.checked = calendarVisibility[source] !== false;
                toggle.onchange = (e) => {
                    calendarVisibility[source] = e.target.checked;
                };
                row.appendChild(label);
                row.appendChild(toggle);
                container.appendChild(row);
            });
        }

        function setupSettings() {
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.remove('active');
            });

            document.getElementById('save-settings').addEventListener('click', () => {
                saveState(); // Save before modifying settings
                const key = document.getElementById('settings-api-key').value.trim();
                localStorage.setItem('gemini_api_key', key);

                const inputs = document.querySelectorAll('.class-name-edit');
                inputs.forEach(input => {
                    const index = parseInt(input.dataset.index);
                    if (grades[index]) grades[index].name = input.value.trim();
                });

                saveGrades();
                saveToLocal();
                populateClassSelect();
                document.getElementById('settings-modal').classList.remove('active');
                alert('Settings Saved!');
            });
            const clearDataBtn = document.getElementById('clear-data-btn');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                        // Clear memory variables FIRST
                        assignments = [];
                        grades = [];
                        aiChatHistory = [];
                        appHistory = [];
                        redoStack = [];
                        calendarVisibility = {};

                        // Then clear localStorage
                        localStorage.clear();

                        // Then reload
                        location.reload();
                    }
                });
            }
        }

        function openAddModal(dateStr = null) {
            document.getElementById('modal-task-id').value = '';
            document.getElementById('modal-task-header').innerText = 'Add New Event';
            document.getElementById('modal-task-title').value = '';

            if (dateStr) {
                // From calendar double click
                const now = new Date();
                // Add current time to the selected date
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('modal-due-date').value = `${dateStr}T${h}:${m}`;
            } else {
                document.getElementById('modal-due-date').value = '';
            }

            document.getElementById('modal-notes').value = '';
            document.getElementById('modal-priority').value = 'Medium';
            // Reset Class Select to first option or placeholder
            if (modalClassSelect.options.length > 0) {
                modalClassSelect.selectedIndex = 0;
                updateModalCategorySelect();
            }
            addTaskModal.classList.add('active');
        }

        function editAssignment(id) {
            const task = assignments.find(t => t.id === id);
            if (!task) return;

            document.getElementById('modal-task-id').value = task.id;
            document.getElementById('modal-task-header').innerText = 'Edit Event';

            // CRITICAL FIX: Set Class FIRST, then trigger category update
            if (modalClassSelect) {
                modalClassSelect.value = task.className;
                updateModalCategorySelect(); // Update categories based on selected class
            }

            // Then set category (if it exists in the new list)
            if (modalCategorySelect && task.category) {
                modalCategorySelect.value = task.category;
            }

            document.getElementById('modal-task-title').value = task.title;
            document.getElementById('modal-due-date').value = task.dueDate;
            document.getElementById('modal-priority').value = task.priority;
            document.getElementById('modal-notes').value = task.notes || '';

            addTaskModal.classList.add('active');
        }

        function addAssignment(e) {
            e.preventDefault();
            saveState(); // Save before change

            const id = document.getElementById('modal-task-id').value;
            const className = document.getElementById('modal-class-select').value;
            const category = document.getElementById('modal-category-select').value;
            const title = document.getElementById('modal-task-title').value;
            const dueDate = document.getElementById('modal-due-date').value;
            const priority = document.getElementById('modal-priority').value;
            const notes = document.getElementById('modal-notes').value;

            if (id) {
                // Edit existing
                const index = assignments.findIndex(t => t.id === id);
                if (index !== -1) {
                    // CRITICAL FIX: Ensure we don't change className unless user selected a new one.
                    // The form value is correct because we set it in editAssignment.
                    assignments[index] = { ...assignments[index], className, category, title, dueDate, priority, notes };
                }
            } else {
                // Add New
                const newTask = {
                    id: Date.now().toString(),
                    className,
                    category,
                    title,
                    dueDate,
                    priority,
                    completed: false,
                    notes
                };
                assignments.push(newTask);


            }

            saveToLocal();
            addTaskModal.classList.remove('active');
        }

        function toggleModalAllDay() {
            const input = document.getElementById('modal-due-date');
            const isAllDay = document.getElementById('modal-all-day-toggle').checked;

            if (isAllDay) {
                // Change input type to date (removes time)
                input.type = 'date';
                // If there's a datetime value, extract just the date part
                if (input.value && input.value.includes('T')) {
                    input.value = input.value.split('T')[0];
                }
            } else {
                // Change back to datetime-local (shows time)
                input.type = 'datetime-local';
                // If there's just a date, add default time of 23:59
                if (input.value && !input.value.includes('T')) {
                    input.value = input.value + 'T23:59';
                }
            }
        }

        function deleteAssignment(id) {
            if (confirm('Delete this assignment?')) {
                saveState(); // Save before delete
                assignments = assignments.filter(t => t.id !== id);
                saveToLocal();
            }
        }

        function toggleComplete(id) {
            saveState(); // Save before toggle
            const task = assignments.find(t => t.id === id);
        }

        function renderAll() {
            renderTasks();
            renderStats();
            renderCalendar();
        }

        function renderTasks() {
            if (!pendingContainer || !completedContainer) return;

            pendingContainer.innerHTML = '';
            completedContainer.innerHTML = '';
            urgentList.innerHTML = '';
            nextEventsList.innerHTML = '';

            // Filter logic
            let filtered = assignments;
            if (currentFilter === 'today') {
                const today = new Date().toISOString().split('T')[0];
                filtered = assignments.filter(t => t.dueDate.startsWith(today));
                filterStatusContainer.style.display = 'flex';
                filterStatusText.innerText = "Filtering: Due Today";
            } else if (currentFilter === 'week') {
                const now = new Date();
                const nextWeek = new Date();
                nextWeek.setDate(now.getDate() + 7);
                filtered = assignments.filter(t => {
                    const d = new Date(t.dueDate);
                    return d >= now && d <= nextWeek;
                });
                filterStatusContainer.style.display = 'flex';
                filterStatusText.innerText = "Filtering: Due This Week";
            } else if (currentFilter === 'urgent') {
                filtered = assignments.filter(t => t.priority === 'Critical' || t.priority === 'High');
                filterStatusContainer.style.display = 'flex';
                filterStatusText.innerText = "Filtering: Urgent Tasks";
            } else if (currentFilter === 'next10') {
                // Only pending, sorted by date
                filtered = assignments.filter(t => !t.completed).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).slice(0, 10);
                filterStatusContainer.style.display = 'flex';
                filterStatusText.innerText = "Filtering: Next 10 Events";
            } else {
                filterStatusContainer.style.display = 'none';
            }

            let sorted = [...filtered];
            if (currentSort === 'date') {
                sorted.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            } else if (currentSort === 'priority') {
                const pVal = { 'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
                sorted.sort((a, b) => pVal[a.priority] - pVal[b.priority]);
            }

            sorted.forEach(task => {
                const date = new Date(task.dueDate).toLocaleDateString();
                const time = new Date(task.dueDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const html = `
                    <div class="task-item glass ${task.priority === 'Critical' ? 'glow-critical' : ''}">
                        <div style="flex:1;" onclick="toggleComplete('${task.id}')" ondblclick="editAssignment('${task.id}'); event.stopPropagation();">
                            <h4>${task.title}</h4>
                            <p style="font-size:0.85rem; color:var(--text-muted);">${task.className} ‚Ä¢ ${date} ${time} ${task.category ? '‚Ä¢ ' + task.category : ''}</p>
                            ${task.notes ? `<p style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">üìù ${task.notes}</p>` : ''}
                        </div>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <span class="priority-badge p-${task.priority}">${task.priority}</span>
                            
                            <!-- Pencil Icon for Editing -->
                            <button class="btn-icon" onclick="editAssignment('${task.id}')" title="Edit Event">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                                                        <!-- Toggle Complete/Incomplete Icon -->
    <button class="btn-icon" onclick="toggleComplete('${task.id}')" title="${task.completed ? 'Restore to Assignments' : 'Mark as Complete'}" style="color: ${task.completed ? '#f59e0b' : '#10b981'};">
        ${task.completed ?
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>' :
                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                    }
    </button>
                            
                            <button class="btn-icon" onclick="askAI('${task.id}')" title="Get Help from Gemini">‚ú®</button>
                            <button class="btn-icon" style="color: #ef4444;" onclick="deleteAssignment('${task.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;

                if (task.completed) {
                    completedContainer.innerHTML += html;
                } else {
                    pendingContainer.innerHTML += html;

                    if (task.priority === 'Critical' || task.priority === 'High') {
                        urgentList.innerHTML += `<li style="padding:0.5rem 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem; cursor:pointer;" onclick="editAssignment('${task.id}')">
                            <span style="color:${task.priority === 'Critical' ? 'var(--priority-critical)' : 'var(--priority-high)'}">‚óè</span> 
                            ${task.title} <span style="color:var(--text-muted); font-size:0.8rem;">(${date})</span>
                        </li>`;
                    }

                    if (nextEventsList.children.length < 5) {
                        nextEventsList.innerHTML += `<li style="padding:0.5rem 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem; cursor:pointer;" onclick="editAssignment('${task.id}')">
                            <span style="color:var(--accent-color)">‚óè</span> 
                            ${task.title} <span style="color:var(--text-muted); font-size:0.8rem;">(${date})</span>
                        </li>`;
                    }
                }
            });
        }

        function renderStats() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(now.getDate() + 7);

            const dueToday = assignments.filter(t => !t.completed && t.dueDate.startsWith(today)).length;
            const dueWeek = assignments.filter(t => {
                const d = new Date(t.dueDate);
                return !t.completed && d >= now && d <= nextWeek;
            }).length;

            // Calculate completion for THIS WEEK only
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 7);

            const tasksThisWeek = assignments.filter(t => {
                const d = new Date(t.dueDate);
                return d >= startOfWeek && d < endOfWeek;
            });

            const completedThisWeek = tasksThisWeek.filter(t => t.completed).length;
            const totalThisWeek = tasksThisWeek.length;
            const progress = totalThisWeek === 0 ? 0 : Math.round((completedThisWeek / totalThisWeek) * 100);

            if (document.getElementById('due-today-count')) document.getElementById('due-today-count').innerText = dueToday;
            if (document.getElementById('due-week-count')) document.getElementById('due-week-count').innerText = dueWeek;

            if (weeklyProgress && progressText) {
                weeklyProgress.style.width = `${progress}%`;
                progressText.innerText = `${progress}%`;
            }
        }

        function renderCalendar() {
            if (!calendarGrid) return;
            calendarGrid.innerHTML = '';
            const date = new Date();
            const month = date.getMonth();
            const year = date.getFullYear();
            const todayDay = date.getDate(); // Get today's day number

            document.getElementById('calendar-month-year').innerText = date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Calendar Filters Rendering
            calendarFilters.innerHTML = '';
            // Get unique classes/sources
            const sources = new Set(grades.map(g => g.name));
            assignments.forEach(a => sources.add(a.className));

            sources.forEach(source => {
                const isActive = calendarVisibility[source] !== false;
                const pill = document.createElement('div');
                pill.className = `cal-filter-pill ${isActive ? 'active' : ''}`;
                pill.innerText = source;
                pill.onclick = () => {
                    calendarVisibility[source] = !isActive;
                    saveToLocal(); // Save visibility state
                    renderCalendar(); // Re-render
                };
                calendarFilters.appendChild(pill);
            });

            for (let i = 0; i < firstDay; i++) {
                calendarGrid.innerHTML += `<div class="calendar-day" style="background:transparent; cursor:default;"></div>`;
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';

                // Check if this is today
                if (i === todayDay) {
                    dayDiv.classList.add('current-day');
                }

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

                // Add Double Click Listener for Adding Events
                dayDiv.ondblclick = () => openAddModal(dateStr);

                let dayContent = `<span class="day-number">${i}</span>`;

                const dayTasks = assignments.filter(t => {
                    if (calendarVisibility[t.className] === false) return false; // Check filter
                    return t.dueDate.startsWith(dateStr) && !t.completed;
                });

                dayTasks.forEach(t => {
                    dayContent += `<div class="cal-task" title="${t.title}" onclick="event.stopPropagation(); editAssignment('${t.id}')">${t.title}</div>`;
                });

                dayDiv.innerHTML = dayContent;
                calendarGrid.appendChild(dayDiv);
            }
        }

        function setupMusicPlayer() {
            const playlist = [
                {
                    title: "Chillhop Stream",
                    artist: "FluxFM",
                    url: "https://fluxfm.streamabc.net/flx-chillhop-mp3-128-8581707?sABC=691r4n8r%230%235n3s88qsqp175p479no0590s780775q4%23fgernzf.syhksz.qr&aw_0_1st.playerid=streams.fluxfm.de&amsparams=playerid:streams.fluxfm.de;skey:1763592846"
                }
            ];
            let currentTrackIndex = 0; const audio = new Audio(); let isPlaying = false;
            const playPauseBtn = document.getElementById('play-pause');

            const rewindBtn = document.getElementById('rewind-btn');
            const forwardBtn = document.getElementById('forward-btn');

            const seekSlider = document.getElementById('seek-slider');
            const volumeSlider = document.getElementById('volume-slider');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const trackTitle = document.getElementById('track-title');
            const trackArtist = document.getElementById('track-artist');

            function loadTrack(index) {
                const track = playlist[index];
                audio.src = track.url;
                trackTitle.innerText = track.title;
                trackArtist.innerText = track.artist;
                audio.load();
            }

            // Automatic Duration Detection
            audio.addEventListener('loadedmetadata', () => {
                if (audio.duration === Infinity) {
                    durationEl.innerText = "Live";
                } else {
                    const m = Math.floor(audio.duration / 60);
                    const s = Math.floor(audio.duration % 60).toString().padStart(2, '0');
                    durationEl.innerText = `${m}:${s}`;
                }
            });

            // Helper to update volume gradient UI
            function updateVolumeUI(val) {
                volumeSlider.style.background = `linear-gradient(to right, var(--accent-color) 0%, var(--highlight) ${val}%, rgba(255, 255, 255, 0.1) ${val}%, rgba(255, 255, 255, 0.1) 100%)`;
            }

            // VOLUME PERSISTENCE
            const savedVolume = localStorage.getItem('volume') || 100;
            volumeSlider.value = savedVolume;

            // Use logarithmic scale for initial volume (x^2)
            audio.volume = savedVolume == 0 ? 0 : Math.pow(savedVolume / 100, 2);
            updateVolumeUI(savedVolume);

            volumeSlider.addEventListener('input', (e) => {
                const val = e.target.value;
                audio.volume = val == 0 ? 0 : Math.pow(val / 100, 2);
                localStorage.setItem('volume', val);
                updateVolumeUI(val);
            });

            playPauseBtn.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play();
                    playPauseBtn.querySelector('.play-icon').style.display = 'none';
                    playPauseBtn.querySelector('.pause-icon').style.display = 'block';
                } else {
                    audio.pause();
                    playPauseBtn.querySelector('.play-icon').style.display = 'block';
                    playPauseBtn.querySelector('.pause-icon').style.display = 'none';
                }
            });

            // Update Time Display
            audio.addEventListener('timeupdate', () => {
                const m = Math.floor(audio.currentTime / 60);
                const s = Math.floor(audio.currentTime % 60).toString().padStart(2, '0');
                currentTimeEl.innerText = `${m}:${s}`;

                if (audio.duration !== Infinity && audio.duration) {
                    seekSlider.value = (audio.currentTime / audio.duration) * 100;
                }
            });

            // Forward & Rewind Buttons
            rewindBtn.addEventListener('click', () => {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
            });

            forwardBtn.addEventListener('click', () => {
                audio.currentTime = audio.currentTime + 10;
            });

            loadTrack(currentTrackIndex);
        }

        // --- AI TUTOR LOGIC ---

        async function askAI(taskId = null) {
            if (taskId) {
                const task = assignments.find(t => t.id === taskId);
                if (!task) return;
                currentAiTask = task;
                document.getElementById('ai-modal-title').innerText = `‚ú® Help with: ${task.title}`;
                document.getElementById('ai-chat-container').innerHTML = `<div class="ai-msg">I see you're working on "<strong>${task.title}</strong>". How can I help you with this? I can explain concepts, generate practice problems, or summarize text.</div>`;
            }

            document.getElementById('ai-modal').classList.add('active');
        }

        document.getElementById('ai-send').addEventListener('click', async () => {
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            if (!text && !aiAttachment) return;

            const chatContainer = document.getElementById('ai-chat-container');
            const apiKey = localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                chatContainer.innerHTML += `<div class="ai-msg" style="background: rgba(239,68,68,0.2); border-color: #ef4444;">Please set your Google Gemini API Key in Settings (‚öôÔ∏è) first!</div>`;
                return;
            }

            // Add User Message
            chatContainer.innerHTML += `<div class="user-msg">${text} ${aiAttachment ? '<br><small>[File Attached]</small>' : ''}</div>`;
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add Loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ai-loading';
            loadingDiv.innerText = 'Thinking...';
            chatContainer.appendChild(loadingDiv);

            try {
                // Prepare prompt
                let fullPrompt = text;
                if (currentAiTask) {
                    fullPrompt = `Context: I am a student working on an assignment titled "${currentAiTask.title}" for class "${currentAiTask.className}". \n\nUser Question: ${text}`;
                }

                const parts = [{ text: fullPrompt }];

                if (aiAttachment) {
                    // Convert base64 string back to format needed if necessary, or just send logic
                    // Simplification: Assuming Gemini 1.5 Flash for image/pdf analysis
                    parts.push({
                        inlineData: {
                            mimeType: aiAttachment.type,
                            data: aiAttachment.data
                        }
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: parts }]
                    })
                });

                const data = await response.json();
                chatContainer.removeChild(loadingDiv);

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiText = data.candidates[0].content.parts[0].text;

                // Format AI Response (Basic Markdown to HTML)
                const formattedText = aiText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                const aiDiv = document.createElement('div');
                aiDiv.className = 'ai-msg ai-content';
                aiDiv.innerHTML = formattedText;
                chatContainer.appendChild(aiDiv);

                // Render MathJax
                if (window.MathJax) {
                    window.MathJax.typesetPromise([aiDiv]);
                }

                // Save to History
                const timestamp = new Date().toISOString();
                aiChatHistory.push({ role: 'user', text: text, timestamp });
                aiChatHistory.push({ role: 'model', text: aiText, timestamp });
                saveToLocal();

            } catch (error) {
                if (chatContainer.contains(loadingDiv)) chatContainer.removeChild(loadingDiv);
                chatContainer.innerHTML += `<div class="ai-msg" style="background: rgba(239,68,68,0.2); border-color: #ef4444;">Error: ${error.message}</div>`;
            }

            // Clear attachment
            aiAttachment = null;
            document.getElementById('ai-file-preview').style.display = 'none';
        });

        // File Attachment Logic
        document.getElementById('ai-attach-btn').addEventListener('click', () => document.getElementById('ai-file-input').click());
        document.getElementById('ai-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                aiAttachment = {
                    type: file.type,
                    data: base64Data,
                    name: file.name
                };
                document.getElementById('ai-filename').innerText = file.name;
                document.getElementById('ai-file-preview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('remove-file-btn').addEventListener('click', () => {
            aiAttachment = null;
            document.getElementById('ai-file-input').value = '';
            document.getElementById('ai-file-preview').style.display = 'none';
        });

        // Add Ctrl+Enter shortcut for AI Tutor
        const aiInput = document.getElementById('ai-input');
        const aiSendBtn = document.getElementById('ai-send');
        if (aiInput && aiSendBtn) {
            aiInput.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    aiSendBtn.click();
                }
            });
        }

        // AI History Features
        document.getElementById('ai-history-btn').addEventListener('click', () => {
            renderAiHistory();
            document.getElementById('ai-history-modal').classList.add('active');
        });

        function renderAiHistory() {
            const list = document.getElementById('ai-history-list');
            list.innerHTML = '';
            if (aiChatHistory.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-muted);">No history yet.</p>';
                return;
            }

            // Group by conversation roughly (simply listing user prompts for now)
            aiChatHistory.forEach((msg, index) => {
                if (msg.role === 'user') {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    const date = new Date(msg.timestamp).toLocaleString();
                    div.innerHTML = `<div class="history-question">${msg.text.substring(0, 50)}${msg.text.length > 50 ? '...' : ''}</div><div class="history-timestamp">${date}</div>`;
                    div.onclick = () => {
                        // Load this point in history into the main chat
                        const chatContainer = document.getElementById('ai-chat-container');
                        chatContainer.innerHTML = '';
                        const response = aiChatHistory[index + 1];

                        chatContainer.innerHTML += `<div class="user-msg">${msg.text}</div>`;
                        if (response && response.role === 'model') {
                            const formattedText = response.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                            const aiDiv = document.createElement('div');
                            aiDiv.className = 'ai-msg ai-content';
                            aiDiv.innerHTML = formattedText;
                            chatContainer.appendChild(aiDiv);
                            if (window.MathJax) window.MathJax.typesetPromise([aiDiv]);
                        }
                        document.getElementById('ai-history-modal').classList.remove('active');
                        document.getElementById('ai-modal').classList.add('active');
                    };
                    list.appendChild(div);
                }
            });
        }

        function clearAiHistory() {
            if (confirm('Clear all chat history?')) {
                aiChatHistory = [];
                saveToLocal();
                renderAiHistory();
            }
        }

        // --- UTILITY FUNCTIONS ---

        function switchTab(tabId) {
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            // Refresh views
            if (tabId === 'dashboard') renderStats();
            if (tabId === 'calendar') renderCalendar();
            if (tabId === 'grades') renderGrades();
        }

        function filterView(criteria) {
            currentFilter = criteria;
            switchTab('pending');
            renderTasks();
        }

        function clearFilters() {
            currentFilter = 'all';
            renderTasks();
        }

        function goToHistory(period) {
            const container = document.getElementById('completed-tasks-container');
            const msg = document.getElementById('history-filter-msg');
            switchTab('completed');

            if (period === 'week') {
                // Show visual indication
                msg.style.display = 'block';
                // Actual filtering would happen if we rebuilt the renderCompleted logic to accept filters
                // For now, just UI switch
            } else {
                msg.style.display = 'none';
            }
        }

        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        }
        function setupHistory() {
            const clearBtn = document.getElementById('clear-completed');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    // Check if there is anything to clear first
                    const hasCompleted = assignments.some(t => t.completed);

                    if (!hasCompleted) {
                        alert("No completed tasks to clear!");
                        return;
                    }

                    if (confirm('Are you sure you want to clear all completed tasks?')) {
                        saveState(); // Save state for Ctrl+Z Undo functionality

                        // Keep only tasks that are NOT completed
                        assignments = assignments.filter(task => !task.completed);

                        saveToLocal(); // This saves to localStorage and calls renderAll()

                        // Optional: Visual feedback
                        alert("History cleared successfully.");
                    }
                });
            }
        }

        function setupSorting() {
            document.getElementById('sort-date').addEventListener('click', () => {
                currentSort = 'date';
                renderTasks();
            });
            document.getElementById('sort-priority').addEventListener('click', () => {
                currentSort = 'priority';
                renderTasks();
            });
        }

        function setupTimer() {
            const display = document.getElementById('timer-display');
            const miniDisplay = document.getElementById('mini-timer-display');
            const startBtn = document.getElementById('timer-start');
            const pauseBtn = document.getElementById('timer-pause');
            const resetBtn = document.getElementById('timer-reset');
            const miniToggle = document.getElementById('mini-timer-toggle');
            const phaseDisplay = document.getElementById('timer-phase');
            const sessionCountDisplay = document.getElementById('session-count');

            function updateDisplay() {
                const m = Math.floor(timerState.timeLeft / 60).toString().padStart(2, '0');
                const s = (timerState.timeLeft % 60).toString().padStart(2, '0');
                const str = `${m}:${s}`;
                display.innerText = str;
                miniDisplay.innerText = str;
                document.title = `(${str}) Student Command Center`;
            }

            function tick() {
                if (timerState.timeLeft > 0) {
                    timerState.timeLeft--;
                    updateDisplay();
                } else {
                    // Timer Finished
                    clearInterval(timerInterval);
                    timerState.isRunning = false;
                    new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    alert(timerState.mode === 'work' ? "Time for a break!" : "Back to work!");

                    if (timerState.mode === 'work') {
                        timerState.sessionCount++;
                        if (timerState.sessionCount % 4 === 0) {
                            timerState.mode = 'longBreak';
                            timerState.timeLeft = timerState.settings.longBreak * 60;
                        } else {
                            timerState.mode = 'shortBreak';
                            timerState.timeLeft = timerState.settings.shortBreak * 60;
                        }
                    } else {
                        timerState.mode = 'work';
                        timerState.timeLeft = timerState.settings.work * 60;
                    }

                    updateUI();
                    saveTimerSettings();
                }
            }

            function start() {
                if (!timerState.isRunning) {
                    timerState.isRunning = true;
                    timerInterval = setInterval(tick, 1000);
                    updateUI();
                }
            }

            function pause() {
                timerState.isRunning = false;
                clearInterval(timerInterval);
                updateUI();
            }

            function reset(force = false) {
                pause();
                if (force || confirm("Reset timer?")) {
                    timerState.mode = 'work';
                    timerState.timeLeft = timerState.settings.work * 60;
                    updateUI();
                }
            }

            function updateUI() {
                startBtn.style.display = timerState.isRunning ? 'none' : 'inline-block';
                pauseBtn.style.display = timerState.isRunning ? 'inline-block' : 'none';

                // Update mini toggle icon
                const playIcon = miniToggle.querySelector('.play-icon');
                const pauseIcon = miniToggle.querySelector('.pause-icon');
                if (timerState.isRunning) {
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                } else {
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                }

                phaseDisplay.innerText = timerState.mode === 'work' ? 'Work Session' : (timerState.mode === 'longBreak' ? 'Long Break' : 'Short Break');
                sessionCountDisplay.innerText = `Sessions: ${timerState.sessionCount}/4`;
                updateDisplay();
            }

            startBtn.onclick = start;
            pauseBtn.onclick = pause;
            resetBtn.onclick = () => reset();
            miniToggle.onclick = (e) => {
                e.stopPropagation();
                if (timerState.isRunning) pause(); else start();
            };

            document.getElementById('save-timer-settings').onclick = () => {
                const w = parseInt(document.getElementById('work-duration').value);
                const sb = parseInt(document.getElementById('short-break-duration').value);
                const lb = parseInt(document.getElementById('long-break-duration').value);
                timerState.settings = { work: w, shortBreak: sb, longBreak: lb };
                saveTimerSettings();
                reset(true);
                alert('Timer settings saved.');
            };

            updateUI();
        }

        function setupImporter() {
            // Basic ICS parsing logic utilizing ical.js
            const dropZone = document.getElementById('drop-zone');
            const input = document.getElementById('ics-input');
            const list = document.getElementById('import-list');
            const modal = document.getElementById('import-modal');
            let parsedEvents = [];

            dropZone.onclick = () => input.click();
            input.onchange = handleFile;

            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = '#f43f5e'; };
            dropZone.ondragleave = () => { dropZone.style.borderColor = 'var(--glass-border)'; };
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--glass-border)';
                handleFile({ target: { files: e.dataTransfer.files } });
            };

            function handleFile(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    parseICS(content);
                };
                reader.readAsText(file);
            }
        }

        function parseICS(data) {
            try {
                const jcal = ICAL.parse(data);
                const comp = new ICAL.Component(jcal);
                const vevents = comp.getAllSubcomponents('vevent');

                const list = document.getElementById('import-list');
                list.innerHTML = '';

                vevents.forEach((event, index) => {
                    const evt = new ICAL.Event(event);
                    const title = evt.summary;
                    const date = evt.startDate.toJSDate();

                    // Format date for input
                    // Use local time
                    const d = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
                    const dateStr = d.toISOString().slice(0, 16);

                    const div = document.createElement('div');
                    div.style.padding = '0.5rem';
                    div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    div.innerHTML = `
                        <input type="checkbox" class="import-check" data-title="${title}" data-date="${dateStr}" checked>
                        <strong>${title}</strong> <br> <span style="font-size:0.8rem; color:#ccc;">${date.toLocaleString()}</span>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                alert("Error parsing ICS file. Ensure it is valid.");
                console.error(e);
            }
        }

        document.getElementById('confirm-import').onclick = () => {
            saveState(); // Save state before import
            const checkboxes = document.querySelectorAll('.import-check:checked');
            const targetClass = document.getElementById('import-target-class').value;

            checkboxes.forEach(box => {
                assignments.push({
                    id: Date.now().toString() + Math.random(),
                    className: targetClass,
                    title: box.dataset.title,
                    dueDate: box.dataset.date,
                    priority: 'Medium',
                    completed: false,
                    notes: 'Imported from Calendar'
                });
            });

            saveToLocal();
            document.getElementById('import-modal').classList.remove('active');
            alert(`Imported ${checkboxes.length} assignments!`);
        };

        document.getElementById('cancel-import').onclick = () => document.getElementById('import-modal').classList.remove('active');

        document.getElementById('select-all-import').onchange = (e) => {
            document.querySelectorAll('.import-check').forEach(c => c.checked = e.target.checked);
        };

        async function importFromUrl() {
            const urlInput = document.getElementById('cal-url-input');
            const url = urlInput.value.trim();

            if (!url) {
                alert("Please enter a valid URL.");
                return;
            }

            const btn = document.getElementById('confirm-url-import');
            const originalText = btn.innerText;
            btn.innerText = "Loading...";
            btn.disabled = true;

            try {
                // Use CORS proxy
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);

                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Network response was not ok');

                const text = await response.text();

                if (!text.includes('BEGIN:VCALENDAR')) {
                    throw new Error('The link did not return a valid calendar file.');
                }

                // --- NEW LINE: Save the URL for auto-syncing later ---
                localStorage.setItem('saved_calendar_url', url);
                // -----------------------------------------------------

                parseICS(text);

                document.getElementById('url-import-modal').classList.remove('active');
                document.getElementById('import-modal').classList.add('active');
                populateImportClassSelect();

                urlInput.value = '';

            } catch (e) {
                console.error(e);
                alert("Failed to import. Check the link and try again.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        async function autoSyncCalendar() {
            // 1. Check if we have a saved URL
            const savedUrl = localStorage.getItem('saved_calendar_url');
            if (!savedUrl) return; // Do nothing if no calendar is linked

            console.log("Auto-syncing calendar...");

            try {
                // 2. Fetch the calendar data silently
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(savedUrl);
                const response = await fetch(proxyUrl);
                if (!response.ok) return;
                const text = await response.text();

                // 3. Parse the events
                const jcal = ICAL.parse(text);
                const comp = new ICAL.Component(jcal);
                const vevents = comp.getAllSubcomponents('vevent');

                let newCount = 0;
                const targetClass = "Imported"; // Default class for auto-synced events

                // 4. Loop through events and check for duplicates
                vevents.forEach(event => {
                    const evt = new ICAL.Event(event);
                    const title = evt.summary;

                    // Handle Date Formatting matches your existing logic
                    const jsDate = evt.startDate.toJSDate();
                    const d = new Date(jsDate.getTime() - (jsDate.getTimezoneOffset() * 60000));
                    const dateStr = d.toISOString().slice(0, 16);

                    // CHECK: Does this assignment already exist? (Same Title AND Same Date)
                    const exists = assignments.some(a => a.title === title && a.dueDate === dateStr);

                    if (!exists) {
                        // Create the new assignment
                        assignments.push({
                            id: Date.now().toString() + Math.random(),
                            className: targetClass,
                            category: 'Calendar',
                            title: title,
                            dueDate: dateStr,
                            priority: 'Medium',
                            completed: false,
                            notes: 'Auto-synced from Calendar'
                        });
                        newCount++;
                    }
                });

                // 5. If we found new stuff, save and notify the user
                if (newCount > 0) {
                    saveToLocal();
                    renderAll();

                    // Show a nice popup toast
                    const toast = document.createElement('div');
                    toast.style.cssText = "position:fixed; bottom:24px; right:24px; background:var(--accent-color); color:white; padding:12px 24px; border-radius:50px; z-index:1000; animation: fadeIn 0.5s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight:500;";
                    toast.innerText = `üìÖ Synced ${newCount} new events from calendar!`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 4000);
                }

            } catch (e) {
                console.error("Auto-sync background error:", e);
            }
        }
        function toggleComplete(id) {
            saveState(); // Save history for Undo

            // Find the specific task being clicked
            const task = assignments.find(t => t.id === id);

            if (task) {
                // Flip the status
                task.completed = !task.completed;

                // THE CONFETTI LOGIC
                if (task.completed) {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }

                saveToLocal(); // Saves and re-renders the screen
            }
        }
        // --- GRADES LOGIC ---

        function setupGrades() {
            const saveBtn = document.getElementById('save-grades');
            saveBtn.addEventListener('click', () => {
                saveGrades();
                alert('Grades saved!');
            });
            renderGrades();
        }

        function renderGrades() {
            const grid = document.getElementById('grades-grid');
            grid.innerHTML = '';

            grades.forEach((course, courseIndex) => {
                let totalWeight = 0;
                let weightedScore = 0;

                course.categories.forEach(cat => {
                    if (cat.score > 0) { // Only count if score is entered
                        // Calculation logic: (Score / 100) * Weight
                        // To get current grade: Sum(Score * Weight) / Sum(Weight of completed items)
                    }
                });

                // Simple Weighted Average Calculation
                let currentGrade = 0;
                let totalW = 0;
                course.categories.forEach(cat => {
                    if (cat.score !== null && cat.score !== undefined && cat.score !== "") {
                        currentGrade += (parseFloat(cat.score) * parseFloat(cat.weight));
                        totalW += parseFloat(cat.weight);
                    }
                });

                const finalGrade = totalW === 0 ? 0 : (currentGrade / totalW);

                const card = document.createElement('div');
                card.className = 'grade-card glass';

                let catHtml = '';
                course.categories.forEach((cat, catIndex) => {
                    catHtml += `
                        <div class="category-row">
                            <input type="text" class="cat-name" value="${cat.name}" onchange="updateGradeData(${courseIndex}, ${catIndex}, 'name', this.value)">
                            <input type="number" class="cat-weight" value="${cat.weight}" placeholder="W%" onchange="updateGradeData(${courseIndex}, ${catIndex}, 'weight', this.value)">
                            <input type="number" class="cat-score" value="${cat.score}" placeholder="Scr" onchange="updateGradeData(${courseIndex}, ${catIndex}, 'score', this.value)">
                            <button class="btn-icon" style="color:#ef4444; font-size:0.8rem;" onclick="removeCategory(${courseIndex}, ${catIndex})">x</button>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="grade-header">
                        <h3>${course.name}</h3>
                        <div class="grade-score">${finalGrade.toFixed(1)}%</div>
                    </div>
                    <div style="display:flex; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem;">
                         <span style="flex:2;">Category</span>
                         <span style="flex:1; text-align:center;">Wght</span>
                         <span style="flex:1; text-align:center;">Score</span>
                         <span style="width:20px;"></span>
                    </div>
                    ${catHtml}
                    <button class="btn-sm" style="margin-top:1rem; width:100%; border-style:dashed;" onclick="addCategory(${courseIndex})">+ Add Category</button>
                `;
                grid.appendChild(card);
            });
        }

        function updateGradeData(courseIdx, catIdx, field, value) {
            saveState(); // Save before change
            grades[courseIdx].categories[catIdx][field] = value;
            renderGrades(); // Re-calc
        }

        function addCategory(courseIdx) {
            saveState(); // Save before change
            grades[courseIdx].categories.push({ name: 'New Category', weight: 10, score: 0 });
            renderGrades();
        }

        function removeCategory(courseIdx, catIdx) {
            saveState(); // Save before change
            grades[courseIdx].categories.splice(catIdx, 1);
            renderGrades();
        }

        document.getElementById('save-grades').addEventListener('click', () => {
            saveGrades();
            alert('Grades saved!');
        });

        function saveGrades() {
            localStorage.setItem('grades', JSON.stringify(grades));
        }

        function populateClassSelect() {
            if (!modalClassSelect) return;
            modalClassSelect.innerHTML = '';
            grades.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.name;
                opt.innerText = g.name;
                modalClassSelect.appendChild(opt);
            });
            updateModalCategorySelect();
        }

        function populateImportClassSelect() {
            const sel = document.getElementById('import-target-class');
            sel.innerHTML = '';
            grades.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.name;
                opt.innerText = g.name;
                sel.appendChild(opt);
            });
        }

        function updateModalCategorySelect() {
            if (!modalCategorySelect || !modalClassSelect) return;
            const className = modalClassSelect.value;
            const course = grades.find(g => g.name === className);
            modalCategorySelect.innerHTML = '<option value="">None</option>';

            if (course && course.categories) {
                course.categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.name;
                    opt.innerText = cat.name;
                    modalCategorySelect.appendChild(opt);
                });
            }
        }

        function resetTimer(force) {
            // Handled inside setupTimer closure via window exposure, 
            // but if called from outside, we need to trigger logic.
            // Since `setupTimer` defines `reset`, we expose it there.
            // This function is just a placeholder or bridge if needed.
        }

        // Make sure we expose the AI chat setup
        function setupAiChat() {
            // Mostly event listeners already attached
        }
    </script>
</body>

</html>
